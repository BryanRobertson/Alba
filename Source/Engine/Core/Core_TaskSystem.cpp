#include "Core_Precompile.hpp"
#include "Core_TaskSystem.hpp"
#include "Core_Memory.hpp"

namespace Alba
{
	namespace Core
	{
		TaskSystem theTaskSystem;

		namespace Detail
		{
			thread_local TaskThreadId theLocalThreadId;
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		/*static*/ TaskSystem& TaskSystem::GetMutable()
		{
			return theTaskSystem;
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		/*static*/ void TaskSystem::Initialise(uint aThreadCount)
		{
			// Set main thread id
			Detail::theLocalThreadId = theMainThreadId;

			theTaskSystem.InitialiseInternal(aThreadCount);
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		/*static*/ void TaskSystem::Shutdown()
		{
			theTaskSystem.ShutdownInternal();
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		/*static*/ void TaskSystem::QueueTask(Task& /*aTask*/)
		{

		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		/*static*/ TaskThreadId	TaskSystem::GetCurrentThreadId()
		{
			return Detail::theLocalThreadId;
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		TaskSystem::TaskSystem()
		{

		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		TaskSystem::~TaskSystem()
		{

		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		void TaskSystem::InitialiseInternal(uint aThreadCount)
		{
			myTaskThreads.reserve(aThreadCount);

			for (uint i = 0; i < aThreadCount; ++i)
			{
				TaskThreadId id{ static_cast<uint16>(i+1) };
				myTaskThreads.emplace_back(ALBA_NEW(AllocationType::TaskSystem, "WorkerThread") TaskWorker{ id });
			}
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		void TaskSystem::ShutdownInternal()
		{
			for (auto& taskWorker : myTaskThreads)
			{
				taskWorker->Join();
			}
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		void TaskSystem::BeginFrame()
		{
			
		}

		//-----------------------------------------------------------------------------------------
		//-----------------------------------------------------------------------------------------
		void TaskSystem::EndFrame()
		{
			
		}
	}
}